# 代理受領通知書 自動生成ツール 引継書 (Handoff Document)

## 1. 目的 (Objective)

国保連から提供される請求データ（CSV/UKE形式）を読み込み、各利用者の「代理受領額」や「受給者番号」「氏名」「対象月」「サービス種別」等を抽出し、指定のExcelテンプレート（原本）に流し込んで、全利用者分のシートが含まれた1つのExcelファイルを自動生成する。
ITリテラシーが高くないユーザーでも、バッチファイル（`.bat`）をダブルクリックし、コマンドプロンプト上で必要な日付等を入力するだけで完結する運用を目指す。

## 2. 完成定義 (Definition of Done)

1.  **データ抽出:** CSV（UKE形式：J131レコード等）から必要な金額（総費用額、利用者負担額、代理受領額、特定障害者給付費）や基本情報（受給者番号、カナ氏名、対象月、サービス種別）が正確に抽出できていること。
2.  **Excel生成:** テンプレートファイル（`代理受領通知書_原本.xlsx`）の「原本」シートをユーザーごとにコピーし、抽出したデータおよびユーザーが入力した日付（発行日、受給日、サービス種別）を正確にマッピングできていること。
3.  **レイアウト保持:** テンプレートの事業者情報等（「株式会社TRINITY PARTNERS」等の社名、代表者名、連絡先）のレイアウト（改行、スペース等）が一切崩れずに、生成された各シートに維持されていること。
4.  **不要シートの排除:** 最終的に出力されるExcelファイルには、ユーザーごとの完成済み通知書シートのみが存在し、テンプレートのマスターシート（「原本」「事業者情報」「受給者情報」等）は残っていない（削除されている）状態であること（1クリック完成の実現）。
5.  **複数月対応:** 同一利用者に複数月（例：9月分と1月分）のデータがある場合、月ごとに別々のシートが生成されること。

## 3. 現状 (Current Status)

### 実装済 (Implemented)

- **CSV解析ロジック:** `generate_receipt.py` にて、Shift-JISエンコーディングのCSVを読み込み、J131(01)レコードから金額、J131(03)レコードからサービス種別コードを抽出する処理を実装済。
- **対話型プロンプト:** 実行時に「発行日」「受給日」、および必要に応じて直接「サービス種別（例: 就労継続支援Ｂ型など）」をコマンドプロンプトでユーザーに入力させる機能を実装済。
- **Excelマッピングと生成:** `openpyxl` を使用し、「原本」シートのコピー、セルへの値の直接書き込み、およびマスターシートの削除処理を実装済。
- **レイアウトの完全コピー機能:** 「原本」シートのセル（H15〜H19）に設定されている改行やスペースを含む事業者情報を `data_only=True` で読み取り、そのままコピー先シートへ書き込む仕組みを実装し、レイアウト崩れの問題を解決済。
- **実行バッチ:** `通知書作成.bat` を用意し、ダブルクリックでPythonスクリプトが起動する環境を構築済。

### 未完 / 課題 (To Do / Known Issues)

- **氏名の漢字変換:** 現状はCSVに記録されている「半角カナ」がそのままシートに出力される仕様。「受給者情報」シート等を用いた漢字氏名へのマッピング（VLOOKUP相当の処理）はPython側で一部実装を試みているが、マスターデータとCSVデータのキー（受給者番号の扱いなど）の照合が完全ではない可能性があるため、出力結果の氏名表記（カナか漢字か）は要確認。
- **サービス種別のマスタ自動変換網羅性:** 現状、内部マスタとして `33: 就労継続支援Ｂ型`、`32: 就労継続支援Ａ型` 等の代表的なものしか定義していない。プロンプトでの手入力機能でカバーしているが、自動化を完璧にするには全コードのマスタ化が必要。
- **エラーハンドリングの強化:** CSVのフォーマットが想定外であった場合や、Excelが開かれたまま実行された場合（PermissionError）などの例外処理をより強固にする余地がある。

## 4. 制約事項・前提条件 (Constraints & Prerequisites)

- **実行環境:** Windows OS、Python 3.11.x
- **ライブラリ:** `openpyxl` のインストールが必須（`pip install openpyxl`）。
- **ファイル構成:**
  - 実行ディレクトリ（`C:\Users\崎久保秀一\Desktop\ClaudeWork\代理受領フォルダ`）内に `generate_receipt.py`、`通知書作成.bat`、`代理受領通知書_原本.xlsx`、および対象の `TH01_*.CSV` が格納されていること。
- **Excelテンプレート依存:** マッピングは現在の `代理受領通知書_原本.xlsx` のレイアウト（セル位置：D7, D8, C25, D25, E26, E27, E29, F25, H4, H15〜19, H30〜34）に強く依存している。テンプレートのレイアウトが変更された場合は、Pythonスクリプトの書き換えが必要となる。
- **ファイルの参照によるエラーの回避:** 数式（Excel関数のVLOOKUPなど）を残すとマスターシート削除時に `#REF!` エラーとなるため、Python側で「計算済み/展開済みの文字列」としてセルに書き込むアプローチを採用していること。
